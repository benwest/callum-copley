{"changed":true,"filter":false,"title":"Project.js","tooltip":"/site/js/components/Project.js","value":"var m = require('mithril');\nvar v2 = require('../utils/vec2');\nvar tween = require('../utils/tween');\n\nvar Page = require('./Page');\n\nvar transition = require('../transition');\nvar throttle = require('lodash/throttle');\nvar { fullscreen, flow, scrollTo } = require('../utils/layout');\n\nvar findParent = ( el, cls ) => {\n    while ( el !== document && !el.classList.contains( cls ) ) {\n        el = el.parentNode;\n    }\n    return el;\n}\n\nvar layout = ( pages, viewport ) => {\n    var { rects } = flow( pages.map( page => fullscreen( page.size, viewport ) ) );\n    var marginX = ( viewport.size[ 0 ] - rects[ 0 ].size[ 0 ] ) / 2;\n    rects.forEach( ({ position }) => {\n        position[ 0 ] += marginX;\n        position[ 1 ] += viewport.margins[ 0 ][ 1 ];\n    });\n    var last = rects[ rects.length - 1 ];\n    var width = last.position[ 0 ] + last.size[ 0 ] + marginX;\n    return { rects, width };\n}\n\nvar cursor = document.querySelector('.cursor');\n\nvar setCursor = e => {\n    if ( e ) e.redraw = false;\n    cursor.classList.add( 'cursor--close' );\n}\n\nvar unsetCursor = e => {\n    if ( e ) e.redraw = false;\n    cursor.classList.remove( 'cursor--close' );\n}\n\nvar cancelRedraw = fn => e => {\n    e.redraw = false;\n    fn( e );\n}\n\nmodule.exports = {\n    scrollLeft: 0,\n    onscroll: ( state, e ) => {\n        state.scrollLeft = e.target.scrollLeft;\n        m.redraw();\n    },\n    close: e => {\n        unsetCursor();\n        var page = [ ...findParent( e.target, 'project' ).querySelectorAll('.page') ].find( p => p.getBoundingClientRect().right > 0 );\n        transition.show()\n            .then(() => {\n                var p = transition.toGrid( page );\n                m.route.set( '/' );\n                return p;\n            }).then( transition.hide );\n    },\n    oninit: ({ state, attrs: { project: { pages }, viewport } }) => {\n        state.onscroll = cancelRedraw( throttle( state.onscroll.bind( null, state ), 1000, { leading: true, trailing: true } ) );\n        var { rects, width } = layout( pages, viewport );\n        state.rects = rects;\n        state.width = width;\n        state.viewport = v2.copy( viewport );\n        state.onclick = e => {\n            var el = e.currentTarget;\n            var cx = viewport.size[ 0 ] / 2;\n            var rect = state.rects.find(\n                e.clientX < viewport.size[ 0 ] / 2\n                    ? rect => state.scrollLeft + rect.position[ 0 ] + rect.size[ 0 ] < cx\n                    : rect => state.scrollLeft + rect.position[ 0 ] > cx\n            );\n            if ( !rect ) return;\n            el.scrollTo( scrollTo( rect, viewport ), 0 )\n        }\n    },\n    oncreate: ({ state, dom, attrs: { params, viewport } }) => {\n        if ( params.page ) {\n            state.scrollLeft = scrollTo( state.rects[ params.page ], viewport );\n            dom.querySelector('.project__scroll').scrollLeft = state.scrollLeft;\n        }\n    },\n    onbeforeupdate: ({ state, attrs: { project: { pages }, viewport } }) => {\n        if ( !v2.equal( state.viewport, viewport ) ) {\n            var { rects, width } = layout( pages, viewport );\n            state.rects = rects;\n            state.width = width;\n            state.viewport = v2.copy( viewport );\n        }\n    },\n    view: ({\n        attrs: { project: { title, pages, slug }, viewport },\n        state: { rects, width, scrollLeft, onscroll, onclick, close }\n    }) => {\n        var minX = viewport.size[ 0 ] * -2;\n        var maxX = viewport.size[ 0 ] * 3;\n        return m('.project', { onscroll },\n            m('.project__scroll', { onscroll /*, onclick */ },\n                m('.project__pages', { style: { width: width + 'px' } },\n                    rects.map( ({ size, position }, i ) => {\n                        var left = position[ 0 ] - scrollLeft;\n                        var visible = left < maxX && left + size[ 0 ] > minX;\n                        if ( !visible ) return undefined;\n                        var page = pages[ i ];\n                        return m( Page, { size, position, src: page.large, key: i, id: `${ slug }_${ i }` })\n                    }),\n                ),\n            ),\n            m('.footer',\n                m('.footer__title', title ),\n                m('a', { onclick: close, onmouseenter: setCursor, onmouseleave: unsetCursor }, 'RETURN' )\n            )\n        )\n    }\n}","undoManager":{"mark":94,"position":100,"stack":[[{"start":{"row":71,"column":35},"end":{"row":71,"column":36},"action":"remove","lines":["i"],"id":6739}],[{"start":{"row":71,"column":35},"end":{"row":71,"column":36},"action":"insert","lines":["f"],"id":6740}],[{"start":{"row":71,"column":36},"end":{"row":71,"column":37},"action":"insert","lines":["i"],"id":6741}],[{"start":{"row":71,"column":37},"end":{"row":71,"column":38},"action":"insert","lines":["n"],"id":6742}],[{"start":{"row":71,"column":38},"end":{"row":71,"column":39},"action":"insert","lines":["d"],"id":6743}],[{"start":{"row":71,"column":39},"end":{"row":71,"column":41},"action":"insert","lines":["()"],"id":6744}],[{"start":{"row":71,"column":40},"end":{"row":71,"column":41},"action":"insert","lines":[" "],"id":6745}],[{"start":{"row":71,"column":40},"end":{"row":71,"column":41},"action":"insert","lines":[" "],"id":6746}],[{"start":{"row":71,"column":41},"end":{"row":71,"column":75},"action":"insert","lines":["e.clientX < viewport.size[ 0 ] / 2"],"id":6747}],[{"start":{"row":71,"column":40},"end":{"row":71,"column":41},"action":"remove","lines":[" "],"id":6748}],[{"start":{"row":71,"column":40},"end":{"row":72,"column":0},"action":"insert","lines":["",""],"id":6749},{"start":{"row":72,"column":0},"end":{"row":72,"column":16},"action":"insert","lines":["                "]}],[{"start":{"row":72,"column":50},"end":{"row":72,"column":51},"action":"remove","lines":[" "],"id":6750}],[{"start":{"row":72,"column":50},"end":{"row":73,"column":0},"action":"insert","lines":["",""],"id":6751},{"start":{"row":73,"column":0},"end":{"row":73,"column":16},"action":"insert","lines":["                "]}],[{"start":{"row":73,"column":12},"end":{"row":73,"column":16},"action":"remove","lines":["    "],"id":6752}],[{"start":{"row":72,"column":50},"end":{"row":73,"column":0},"action":"insert","lines":["",""],"id":6753},{"start":{"row":73,"column":0},"end":{"row":73,"column":16},"action":"insert","lines":["                "]}],[{"start":{"row":73,"column":16},"end":{"row":73,"column":20},"action":"insert","lines":["    "],"id":6754}],[{"start":{"row":73,"column":20},"end":{"row":73,"column":21},"action":"insert","lines":["?"],"id":6755}],[{"start":{"row":73,"column":21},"end":{"row":74,"column":0},"action":"insert","lines":["",""],"id":6756},{"start":{"row":74,"column":0},"end":{"row":74,"column":20},"action":"insert","lines":["                    "]}],[{"start":{"row":74,"column":20},"end":{"row":74,"column":21},"action":"insert","lines":[":"],"id":6757}],[{"start":{"row":77,"column":41},"end":{"row":77,"column":89},"action":"remove","lines":["rect => rect.position[ 0 ] + rect.size[ 0 ] < cx"],"id":6758}],[{"start":{"row":73,"column":21},"end":{"row":73,"column":22},"action":"insert","lines":[" "],"id":6759}],[{"start":{"row":73,"column":22},"end":{"row":73,"column":70},"action":"insert","lines":["rect => rect.position[ 0 ] + rect.size[ 0 ] < cx"],"id":6760}],[{"start":{"row":74,"column":21},"end":{"row":74,"column":22},"action":"insert","lines":[" "],"id":6761}],[{"start":{"row":74,"column":22},"end":{"row":74,"column":23},"action":"insert","lines":["r"],"id":6762}],[{"start":{"row":74,"column":23},"end":{"row":74,"column":24},"action":"insert","lines":["e"],"id":6763}],[{"start":{"row":74,"column":24},"end":{"row":74,"column":25},"action":"insert","lines":["c"],"id":6764}],[{"start":{"row":74,"column":25},"end":{"row":74,"column":26},"action":"insert","lines":["t"],"id":6765}],[{"start":{"row":74,"column":26},"end":{"row":74,"column":27},"action":"insert","lines":["."],"id":6766}],[{"start":{"row":74,"column":26},"end":{"row":74,"column":27},"action":"remove","lines":["."],"id":6767}],[{"start":{"row":74,"column":26},"end":{"row":74,"column":27},"action":"insert","lines":[" "],"id":6768}],[{"start":{"row":74,"column":27},"end":{"row":74,"column":28},"action":"insert","lines":["="],"id":6769}],[{"start":{"row":74,"column":28},"end":{"row":74,"column":29},"action":"insert","lines":[">"],"id":6770}],[{"start":{"row":74,"column":29},"end":{"row":74,"column":30},"action":"insert","lines":[" "],"id":6771}],[{"start":{"row":74,"column":30},"end":{"row":74,"column":31},"action":"insert","lines":["r"],"id":6772}],[{"start":{"row":74,"column":31},"end":{"row":74,"column":32},"action":"insert","lines":["e"],"id":6773}],[{"start":{"row":74,"column":32},"end":{"row":74,"column":33},"action":"insert","lines":["c"],"id":6774}],[{"start":{"row":74,"column":33},"end":{"row":74,"column":34},"action":"insert","lines":["t"],"id":6775}],[{"start":{"row":74,"column":34},"end":{"row":74,"column":35},"action":"insert","lines":["."],"id":6776}],[{"start":{"row":74,"column":35},"end":{"row":74,"column":36},"action":"insert","lines":["p"],"id":6777}],[{"start":{"row":74,"column":36},"end":{"row":74,"column":37},"action":"insert","lines":["o"],"id":6778}],[{"start":{"row":74,"column":37},"end":{"row":74,"column":38},"action":"insert","lines":["s"],"id":6779}],[{"start":{"row":74,"column":38},"end":{"row":74,"column":39},"action":"insert","lines":["i"],"id":6780}],[{"start":{"row":74,"column":39},"end":{"row":74,"column":40},"action":"insert","lines":["t"],"id":6781}],[{"start":{"row":74,"column":40},"end":{"row":74,"column":41},"action":"insert","lines":["i"],"id":6782}],[{"start":{"row":74,"column":41},"end":{"row":74,"column":42},"action":"insert","lines":["o"],"id":6783}],[{"start":{"row":74,"column":42},"end":{"row":74,"column":43},"action":"insert","lines":["n"],"id":6784}],[{"start":{"row":74,"column":43},"end":{"row":74,"column":45},"action":"insert","lines":["[]"],"id":6785}],[{"start":{"row":74,"column":44},"end":{"row":74,"column":45},"action":"insert","lines":[" "],"id":6786}],[{"start":{"row":74,"column":45},"end":{"row":74,"column":46},"action":"insert","lines":["0"],"id":6787}],[{"start":{"row":74,"column":46},"end":{"row":74,"column":47},"action":"insert","lines":[" "],"id":6788}],[{"start":{"row":74,"column":48},"end":{"row":74,"column":49},"action":"insert","lines":[" "],"id":6789}],[{"start":{"row":74,"column":49},"end":{"row":74,"column":50},"action":"insert","lines":[">"],"id":6790}],[{"start":{"row":74,"column":50},"end":{"row":74,"column":51},"action":"insert","lines":[" "],"id":6791}],[{"start":{"row":74,"column":51},"end":{"row":74,"column":52},"action":"insert","lines":["c"],"id":6792}],[{"start":{"row":74,"column":52},"end":{"row":74,"column":53},"action":"insert","lines":["x"],"id":6793}],[{"start":{"row":76,"column":12},"end":{"row":80,"column":13},"action":"remove","lines":["if ( e.clientX < viewport.size[ 0 ] / 2 ) {","                rect = state.rects.find(  )","            } else {","                rect = state.rects.find( rect => rect.position[ 0 ] + rect.size[ 0 ] < cx )","            }"],"id":6794}],[{"start":{"row":76,"column":12},"end":{"row":76,"column":13},"action":"insert","lines":["i"],"id":6795}],[{"start":{"row":76,"column":13},"end":{"row":76,"column":14},"action":"insert","lines":["f"],"id":6796}],[{"start":{"row":76,"column":14},"end":{"row":76,"column":15},"action":"insert","lines":[" "],"id":6797}],[{"start":{"row":76,"column":15},"end":{"row":76,"column":16},"action":"insert","lines":["9"],"id":6798}],[{"start":{"row":76,"column":16},"end":{"row":76,"column":17},"action":"insert","lines":[" "],"id":6799}],[{"start":{"row":76,"column":16},"end":{"row":76,"column":17},"action":"remove","lines":[" "],"id":6800}],[{"start":{"row":76,"column":15},"end":{"row":76,"column":16},"action":"remove","lines":["9"],"id":6801}],[{"start":{"row":76,"column":15},"end":{"row":76,"column":17},"action":"insert","lines":["()"],"id":6802}],[{"start":{"row":76,"column":16},"end":{"row":76,"column":17},"action":"insert","lines":[" "],"id":6803}],[{"start":{"row":76,"column":17},"end":{"row":76,"column":18},"action":"insert","lines":["!"],"id":6804}],[{"start":{"row":76,"column":18},"end":{"row":76,"column":19},"action":"insert","lines":["r"],"id":6805}],[{"start":{"row":76,"column":19},"end":{"row":76,"column":20},"action":"insert","lines":["e"],"id":6806}],[{"start":{"row":76,"column":20},"end":{"row":76,"column":21},"action":"insert","lines":["c"],"id":6807}],[{"start":{"row":76,"column":21},"end":{"row":76,"column":22},"action":"insert","lines":["t"],"id":6808}],[{"start":{"row":76,"column":22},"end":{"row":76,"column":23},"action":"insert","lines":[" "],"id":6809}],[{"start":{"row":76,"column":24},"end":{"row":76,"column":25},"action":"insert","lines":[" "],"id":6810}],[{"start":{"row":76,"column":25},"end":{"row":76,"column":26},"action":"insert","lines":["r"],"id":6811}],[{"start":{"row":76,"column":26},"end":{"row":76,"column":27},"action":"insert","lines":["e"],"id":6812}],[{"start":{"row":76,"column":27},"end":{"row":76,"column":28},"action":"insert","lines":["t"],"id":6813}],[{"start":{"row":76,"column":28},"end":{"row":76,"column":29},"action":"insert","lines":["u"],"id":6814}],[{"start":{"row":76,"column":29},"end":{"row":76,"column":30},"action":"insert","lines":["r"],"id":6815}],[{"start":{"row":76,"column":30},"end":{"row":76,"column":31},"action":"insert","lines":["n"],"id":6816}],[{"start":{"row":76,"column":31},"end":{"row":76,"column":32},"action":"insert","lines":[";"],"id":6817}],[{"start":{"row":73,"column":30},"end":{"row":73,"column":31},"action":"insert","lines":["s"],"id":6818}],[{"start":{"row":73,"column":31},"end":{"row":73,"column":32},"action":"insert","lines":["t"],"id":6819}],[{"start":{"row":73,"column":32},"end":{"row":73,"column":33},"action":"insert","lines":["a"],"id":6820}],[{"start":{"row":73,"column":33},"end":{"row":73,"column":34},"action":"insert","lines":["t"],"id":6821}],[{"start":{"row":73,"column":34},"end":{"row":73,"column":35},"action":"insert","lines":["e"],"id":6822}],[{"start":{"row":73,"column":35},"end":{"row":73,"column":36},"action":"insert","lines":["."],"id":6823}],[{"start":{"row":73,"column":36},"end":{"row":73,"column":37},"action":"insert","lines":["s"],"id":6824}],[{"start":{"row":73,"column":37},"end":{"row":73,"column":38},"action":"insert","lines":["c"],"id":6825}],[{"start":{"row":73,"column":38},"end":{"row":73,"column":39},"action":"insert","lines":["r"],"id":6826}],[{"start":{"row":73,"column":39},"end":{"row":73,"column":40},"action":"insert","lines":["o"],"id":6827}],[{"start":{"row":73,"column":40},"end":{"row":73,"column":41},"action":"insert","lines":["l"],"id":6828}],[{"start":{"row":73,"column":36},"end":{"row":73,"column":41},"action":"remove","lines":["scrol"],"id":6829},{"start":{"row":73,"column":36},"end":{"row":73,"column":46},"action":"insert","lines":["scrollLeft"]}],[{"start":{"row":73,"column":46},"end":{"row":73,"column":47},"action":"insert","lines":[" "],"id":6830}],[{"start":{"row":73,"column":47},"end":{"row":73,"column":48},"action":"insert","lines":["+"],"id":6831}],[{"start":{"row":73,"column":48},"end":{"row":73,"column":49},"action":"insert","lines":[" "],"id":6832}],[{"start":{"row":74,"column":30},"end":{"row":74,"column":49},"action":"insert","lines":["state.scrollLeft + "],"id":6833}],[{"start":{"row":101,"column":44},"end":{"row":101,"column":45},"action":"insert","lines":[" "],"id":6834}],[{"start":{"row":101,"column":45},"end":{"row":101,"column":46},"action":"insert","lines":["/"],"id":6835}],[{"start":{"row":101,"column":46},"end":{"row":101,"column":47},"action":"insert","lines":["*"],"id":6836}],[{"start":{"row":101,"column":56},"end":{"row":101,"column":57},"action":"insert","lines":[" "],"id":6837}],[{"start":{"row":101,"column":57},"end":{"row":101,"column":58},"action":"insert","lines":["*"],"id":6838}],[{"start":{"row":101,"column":58},"end":{"row":101,"column":59},"action":"insert","lines":["/"],"id":6839}]]},"ace":{"folds":[],"scrolltop":1025,"scrollleft":0,"selection":{"start":{"row":101,"column":59},"end":{"row":101,"column":59},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":67,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1536151619040}